rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read/write their own profile and league index
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      match /leagues/{leagueId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // Global course database: any authenticated user can read; site admin can write
    match /courses/{courseId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
        && request.auth.token.email == 'tfisherdesigns@gmail.com';
    }

    // Course requests: any authenticated user can create; site admin can read/update/delete
    match /courseRequests/{requestId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null
        && request.auth.token.email == 'tfisherdesigns@gmail.com';
    }

    // ===== Leagues (multi-tenant) =====
    match /leagues/{leagueId} {
      allow read: if request.auth != null;

      // CREATE: any authenticated user (league creation)
      // Validate: createdBy must be the requester, memberCount starts at 1
      allow create: if request.auth != null
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.memberCount == 1;

      // UPDATE: commissioner/creator for full updates;
      // OR any authed user for memberCount increment only (join flow)
      allow update: if request.auth != null && (
        isCommissioner() ||
        isCreator() ||
        // Join flow: ONLY memberCount changes, increments by exactly 1
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount'])
          && request.resource.data.memberCount == resource.data.memberCount + 1
      );

      // DELETE: only creator (if ever needed)
      allow delete: if request.auth != null && isCreator();

      // ===== Helper functions =====
      function isMember() {
        return request.auth != null &&
          exists(/databases/$(database)/documents/leagues/$(leagueId)/members/$(request.auth.uid));
      }

      function isCommissioner() {
        return request.auth != null &&
          isMember() &&
          get(/databases/$(database)/documents/leagues/$(leagueId)/members/$(request.auth.uid)).data.role == 'commissioner';
      }

      function isCreator() {
        return request.auth != null &&
          get(/databases/$(database)/documents/leagues/$(leagueId)).data.createdBy == request.auth.uid;
      }

      // ===== Config: members read; commissioner/creator write =====
      match /config/{doc} {
        allow read: if isMember();
        allow write: if request.auth != null && (isCommissioner() || isCreator());
      }

      // ===== Members =====
      match /members/{memberUid} {
        allow read: if isMember() || (request.auth != null && request.auth.uid == memberUid);

        // CREATE: user can only create their own doc
        // Join flow: must set role='player', uid must match
        // Creator: can set role='commissioner' on own doc during league creation
        allow create: if request.auth != null
          && request.auth.uid == memberUid
          && request.resource.data.uid == request.auth.uid
          && (
            request.resource.data.role == 'player' ||
            (request.resource.data.role == 'commissioner' && isCreator())
          );

        // UPDATE own doc: cannot change role (prevents self-promotion)
        // UPDATE other member's doc: commissioner only
        allow update: if request.auth != null && (
          (request.auth.uid == memberUid
            && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
          || isCommissioner()
        );

        // DELETE: commissioner only (remove member flow)
        allow delete: if isCommissioner();
      }

      // ===== Matches: members read; members + creator write =====
      match /matches/{matchKey} {
        allow read: if isMember();
        allow write: if request.auth != null && (isMember() || isCreator());
      }

      // ===== Player rounds: members read; members + creator write =====
      match /playerRounds/{playerId} {
        allow read: if isMember();
        allow write: if request.auth != null && (isMember() || isCreator());
      }
    }
  }
}
