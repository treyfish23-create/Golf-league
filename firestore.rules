rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read/write their own profile and league index
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      match /leagues/{leagueId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // League top-level doc: any authenticated user can read (needed for join-code lookup),
    // authenticated users can write (league creation + join memberCount increment)
    match /leagues/{leagueId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;

      // Helper: is the requester a member of this league?
      // (also true during league creation when the league doc itself was just written)
      function isMember() {
        return request.auth != null &&
          exists(/databases/$(database)/documents/leagues/$(leagueId)/members/$(request.auth.uid));
      }

      function isCommissioner() {
        return request.auth != null &&
          isMember() &&
          get(/databases/$(database)/documents/leagues/$(leagueId)/members/$(request.auth.uid)).data.role == 'commissioner';
      }

      // Config: members can read; commissioner OR league creator (writing their own new league) can write
      match /config/{doc} {
        allow read: if isMember();
        // Allow write if commissioner, OR if the league top-level doc was just created by this user
        // (creation flow: league doc written first, then config â€” user is not yet a member)
        allow write: if request.auth != null && (
          isCommissioner() ||
          get(/databases/$(database)/documents/leagues/$(leagueId)).data.createdBy == request.auth.uid
        );
      }

      // Members: members can read all; any authed user can read their own doc (join-check);
      // authenticated users can write (join or commissioner adding players)
      match /members/{memberUid} {
        allow read: if isMember() || (request.auth != null && request.auth.uid == memberUid);
        allow write: if request.auth != null;
      }

      // Matches: members can read, members can write (score entry + seeding)
      match /matches/{matchKey} {
        allow read: if isMember();
        // Allow write if member, OR if creator (seeding during league creation)
        allow write: if request.auth != null && (
          isMember() ||
          get(/databases/$(database)/documents/leagues/$(leagueId)).data.createdBy == request.auth.uid
        );
      }

      // Player rounds: members can read/write
      match /playerRounds/{playerId} {
        allow read: if isMember();
        allow write: if request.auth != null && (
          isMember() ||
          get(/databases/$(database)/documents/leagues/$(leagueId)).data.createdBy == request.auth.uid
        );
      }
    }
  }
}
